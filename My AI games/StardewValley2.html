<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>3D Farm with Shop</title>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background-color: #f0f8e9;
			}
			canvas {
				display: block;
			}
			#info,
			#money-counter {
				position: absolute;
				color: white;
				font-family: Arial, sans-serif;
				font-size: 1.2em;
				text-shadow: 1px 1px 2px black;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
			}
			#info {
				top: 10px;
				left: 10px;
			}
			#money-counter {
				top: 10px;
				right: 10px;
			}
			#message {
				position: absolute;
				bottom: 10px;
				left: 50%;
				transform: translateX(-50%);
				color: white;
				font-family: Arial, sans-serif;
				font-size: 1.2em;
				text-shadow: 1px 1px 2px black;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
				opacity: 0;
				transition: opacity 1s;
			}
			#shop-ui {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background-color: #fff;
				padding: 20px;
				border-radius: 10px;
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
				font-family: Arial, sans-serif;
				z-index: 100;
				display: none;
			}
			.shop-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}
			.buy-button {
				padding: 5px 10px;
				cursor: pointer;
				background-color: #4caf50;
				color: white;
				border: none;
				border-radius: 5px;
			}
			.close-button {
				position: absolute;
				top: 10px;
				right: 10px;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="info">
			Use WASD and mouse to move. Click plots to plant and harvest. Click
			the shop to buy seeds.
		</div>
		<div id="money-counter">Money: $<span id="money">0</span></div>
		<div id="message"></div>

		<div id="shop-ui">
			<button class="close-button" id="close-shop">X</button>
			<h3>Shop</h3>
			<p>Available items:</p>
			<div class="shop-item">
				<span>Seed Pack ($5)</span>
				<button class="buy-button" id="buy-seed">Buy</button>
			</div>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

		<script>
			// --- SCENE SETUP ---
			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera(
				75,
				window.innerWidth / window.innerHeight,
				0.1,
				1000
			);
			const renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);
			camera.position.set(0, 1.6, 15);

			// Lighting
			const ambientLight = new THREE.AmbientLight(0x404040, 2);
			scene.add(ambientLight);
			const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
			directionalLight.position.set(5, 5, 5);
			scene.add(directionalLight);

			// Ground and sky
			const groundGeometry = new THREE.PlaneGeometry(50, 50);
			const groundMaterial = new THREE.MeshLambertMaterial({
				color: 0x669933,
			});
			const ground = new THREE.Mesh(groundGeometry, groundMaterial);
			ground.rotation.x = -Math.PI / 2;
			scene.add(ground);
			const skyGeometry = new THREE.SphereGeometry(250, 32, 32);
			const skyMaterial = new THREE.MeshBasicMaterial({
				color: 0x87ceeb,
				side: THREE.BackSide,
			});
			const sky = new THREE.Mesh(skyGeometry, skyMaterial);
			scene.add(sky);

			// --- GAME LOGIC & STATE ---
			let money = 0;
			let seedInventory = 10; // Start with some seeds
			const plots = [];
			const moneyElement = document.getElementById("money");
			const messageElement = document.getElementById("message");
			const shopUI = document.getElementById("shop-ui");
			const closeShopButton = document.getElementById("close-shop");
			const buySeedButton = document.getElementById("buy-seed");

			const FIELD_STATES = {
				EMPTY: { color: 0x964b00, growTime: 0, model: "plot" },
				PLANTED: {
					color: 0x00ff00,
					growTime: 5,
					model: "plant_stage1",
				},
				GROWING: {
					color: 0x00aa00,
					growTime: 2,
					model: "plant_stage2",
				},
				MATURE: { color: 0xffff00, growTime: 0, model: "plant_stage3" },
			};

			// Create the shop building
			function createShop() {
				const buildingGeometry = new THREE.BoxGeometry(10, 8, 10);
				const buildingMaterial = new THREE.MeshLambertMaterial({
					color: 0xb5651d,
				});
				const shopMesh = new THREE.Mesh(
					buildingGeometry,
					buildingMaterial
				);
				shopMesh.position.set(-15, 4, -15);
				shopMesh.userData = { type: "shop" };
				scene.add(shopMesh);
				return shopMesh;
			}

			const shop = createShop();

			// Create the farm plots
			function createPlot(x, z) {
				const plotGeometry = new THREE.BoxGeometry(2, 0.1, 2);
				const plotMaterial = new THREE.MeshLambertMaterial({
					color: FIELD_STATES.EMPTY.color,
				});
				const plotMesh = new THREE.Mesh(plotGeometry, plotMaterial);
				plotMesh.position.set(x, 0.05, z);
				plotMesh.userData = {
					state: "empty",
					growTime: 0,
					plantMesh: null,
					type: "plot",
				};
				plots.push(plotMesh);
				scene.add(plotMesh);
				return plotMesh;
			}

			// Populate the farm with plots
			for (let x = -4; x <= 4; x += 4) {
				for (let z = -4; z <= 4; z += 4) {
					createPlot(x, z);
				}
			}

			function updatePlantModel(plot) {
				if (plot.userData.plantMesh) {
					scene.remove(plot.userData.plantMesh);
				}

				let newPlantMesh = null;
				if (plot.userData.state === "planted") {
					const plantGeometry = new THREE.ConeGeometry(0.2, 1, 8);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.PLANTED.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				} else if (plot.userData.state === "growing") {
					const plantGeometry = new THREE.CylinderGeometry(
						0.4,
						0.4,
						1.2,
						12
					);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.GROWING.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				} else if (plot.userData.state === "mature") {
					const plantGeometry = new THREE.SphereGeometry(0.5, 12, 12);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.MATURE.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				}

				if (newPlantMesh) {
					newPlantMesh.position.set(
						plot.position.x,
						0.6,
						plot.position.z
					);
					scene.add(newPlantMesh);
					plot.userData.plantMesh = newPlantMesh;
				}
			}

			function showMessage(text) {
				messageElement.textContent = text;
				messageElement.style.opacity = 1;
				setTimeout(() => {
					messageElement.style.opacity = 0;
				}, 3000);
			}

			// Game loop for plant growth
			setInterval(() => {
				plots.forEach((plot) => {
					if (
						plot.userData.state === "planted" ||
						plot.userData.state === "growing"
					) {
						if (plot.userData.growTime > 0) {
							plot.userData.growTime--;
							if (plot.userData.growTime === 2) {
								plot.userData.state = "growing";
								updatePlantModel(plot);
							} else if (plot.userData.growTime === 0) {
								plot.userData.state = "mature";
								updatePlantModel(plot);
								showMessage("A crop is ready to harvest!");
							}
						}
					}
				});
			}, 2000);

			// --- PLAYER CONTROLS & INTERACTION ---
			const raycaster = new THREE.Raycaster();
			const mouse = new THREE.Vector2();

			// Player movement controls
			const controls = {
				forward: false,
				backward: false,
				left: false,
				right: false,
			};
			const playerSpeed = 0.07;
			document.addEventListener("keydown", (e) => {
				if (e.key === "w") controls.forward = true;
				if (e.key === "s") controls.backward = true;
				if (e.key === "a") controls.left = true;
				if (e.key === "d") controls.right = true;
			});
			document.addEventListener("keyup", (e) => {
				if (e.key === "w") controls.forward = false;
				if (e.key === "s") controls.backward = false;
				if (e.key === "a") controls.left = false;
				if (e.key === "d") controls.right = false;
			});
			let isMouseDown = false;
			document.addEventListener("mousedown", () => (isMouseDown = true));
			document.addEventListener("mouseup", () => (isMouseDown = false));
			document.addEventListener("mousemove", (e) => {
				if (isMouseDown) {
					const sensitivity = 0.002;
					camera.rotation.y -= e.movementX * sensitivity;
					camera.rotation.x -= e.movementY * sensitivity;
					camera.rotation.x = Math.max(
						-Math.PI / 2,
						Math.min(Math.PI / 2, camera.rotation.x)
					);
				}
			});

			// Click interaction
			window.addEventListener(
				"click",
				(event) => {
					mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
					mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
					raycaster.setFromCamera(mouse, camera);

					const interactableObjects = [...plots, shop];
					const intersects =
						raycaster.intersectObjects(interactableObjects);

					if (intersects.length > 0) {
						const clickedObject = intersects.object;
						const type = clickedObject.userData.type;

						if (type === "shop") {
							shopUI.style.display = "block";
						} else if (type === "plot") {
							const state = clickedObject.userData.state;
							switch (state) {
								case "empty":
									if (seedInventory > 0) {
										clickedObject.userData.state =
											"planted";
										clickedObject.userData.growTime =
											FIELD_STATES.PLANTED.growTime;
										updatePlantModel(clickedObject);
										seedInventory--;
										showMessage(
											"You planted a new crop! Seeds left: " +
												seedInventory
										);
									} else {
										showMessage(
											"You are out of seeds! Go to the shop to buy more."
										);
									}
									break;
								case "planted":
								case "growing":
									if (clickedObject.userData.growTime > 0) {
										clickedObject.userData.growTime--;
										showMessage("You watered the crop!");
									}
									break;
								case "mature":
									money += 10;
									moneyElement.textContent = money;
									clickedObject.userData.state = "empty";
									clickedObject.userData.growTime = 0;
									scene.remove(
										clickedObject.userData.plantMesh
									);
									clickedPlot.userData.plantMesh = null;
									showMessage(
										"You harvested a crop and earned $10!"
									);
									break;
							}
						}
					}
				},
				false
			);

			// Shop UI actions
			closeShopButton.addEventListener("click", () => {
				shopUI.style.display = "none";
			});

			buySeedButton.addEventListener("click", () => {
				const seedPrice = 5;
				if (money >= seedPrice) {
					money -= seedPrice;
					seedInventory += 5; // Buy 5 seeds
					moneyElement.textContent = money;
					showMessage(
						`You bought 5 seeds for $${seedPrice}! Seeds left: ${seedInventory}`
					);
				} else {
					showMessage("Not enough money!");
				}
			});

			// --- ANIMATION LOOP ---
			function animate() {
				requestAnimationFrame(animate);

				// Movement logic
				const direction = new THREE.Vector3();
				camera.getWorldDirection(direction);
				const right = new THREE.Vector3();
				right.crossVectors(direction, camera.up);

				if (controls.forward)
					camera.position.add(direction.multiplyScalar(playerSpeed));
				if (controls.backward)
					camera.position.add(direction.multiplyScalar(-playerSpeed));
				if (controls.left)
					camera.position.add(right.multiplyScalar(-playerSpeed));
				if (controls.right)
					camera.position.add(right.multiplyScalar(playerSpeed));

				renderer.render(scene, camera);
			}
			animate();
		</script>
	</body>
</html>
