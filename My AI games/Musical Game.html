<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeatBox: A Fun Musical Game</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#16a34a;
    --glass: rgba(255,255,255,0.04);
    --pad-size: 140px;
    --pad-gap: 16px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;user-select:none}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%, #082036 100%);color:#e6eef8}
  .wrap{max-width:980px;margin:28px auto;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between}
  h1{font-size:20px;margin:0}
  p.lead{color:#bcd3ff;margin:6px 0 0;font-size:13px}
  .game{
    display:flex;
    gap:24px;
    margin-top:18px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .left{
    display:grid;
    gap:var(--pad-gap);
    grid-template-columns:repeat(2, var(--pad-size));
    padding:18px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    box-shadow:inset 0 -10px 30px rgba(0,0,0,0.4);
  }
  .pad{
    width:var(--pad-size);
    height:var(--pad-size);
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:26px;
    color:rgba(255,255,255,0.95);
    cursor:pointer;
    transform:translateZ(0);
    transition:transform .12s ease, filter .12s;
    box-shadow: 0 8px 20px rgba(2,6,23,0.6), inset 0 -4px 18px rgba(0,0,0,0.2);
  }
  .pad:active{transform:scale(.98)}
  .pad.green{background:linear-gradient(180deg,#10b981,#059669);--tone:0;}
  .pad.red  {background:linear-gradient(180deg,#ef4444,#dc2626);--tone:1;}
  .pad.yellow{background:linear-gradient(180deg,#f59e0b,#d97706);--tone:2;}
  .pad.blue {background:linear-gradient(180deg,#3b82f6,#2563eb);--tone:3;}
  .pad.flash{filter:brightness(1.35) saturate(1.2);transform:scale(1.04);box-shadow:0 12px 28px rgba(0,0,0,0.6), 0 0 32px rgba(255,255,255,0.06) inset}
  .right{
    flex:1;
    min-width:260px;
  }
  .panel{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    margin-bottom:12px;
    box-shadow:0 6px 24px rgba(2,6,23,0.6);
  }
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button, .mode-btn{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    color:#dff3ff;border:1px solid rgba(255,255,255,0.04);
    padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;
  }
  .mode-btn.active{background:linear-gradient(90deg,#0ea5a4,#22c55e);color:#041019;border:1px solid rgba(255,255,255,0.06);box-shadow:0 6px 18px rgba(34,197,94,0.12)}
  .small{font-size:13px;padding:6px 10px}
  .muted{color:#93a7c1;font-size:13px}
  .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .stat{background:var(--glass);padding:8px 10px;border-radius:10px;font-weight:700;color:#e6f3ff}
  .instructions{font-size:13px;color:#cfe6ff;line-height:1.45}
  .footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
  .kbd{background:#082036;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
  .mode-select{display:flex;gap:8px;margin-bottom:8px}
  .center{display:flex;align-items:center;justify-content:center}
  .big-score{font-size:44px;font-weight:800;letter-spacing:-1px}
  @media (max-width:720px){
    .game{flex-direction:column;align-items:center}
    .right{width:100%}
  }
  /* subtle pulse when sequence plays */
  .pulse { animation: pulseGlow 700ms cubic-bezier(.2,.9,.2,1); }
  @keyframes pulseGlow {
    0% { box-shadow: 0 6px 18px rgba(2,6,23,0.6); transform:scale(1); }
    50% { box-shadow: 0 18px 46px rgba(2,6,23,0.85); transform:scale(1.01); }
    100% { box-shadow: 0 6px 18px rgba(2,6,23,0.6); transform:scale(1); }
  }
  footer.note{margin-top:8px;color:#9fb7d4;font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>BeatBox â€” A Fun Musical Game</h1>
        <p class="lead">Press the pads, follow the sequence, and score streaks. Keys A S D F work too. ðŸŽ§</p>
      </div>
      <div class="muted">Made with Web Audio â€¢ No downloads</div>
    </header>

    <div class="game">
      <div class="left" id="padGrid" aria-hidden="false">
        <div class="pad green" data-pad="0" data-key="A">A</div>
        <div class="pad red"   data-pad="1" data-key="S">S</div>
        <div class="pad yellow"data-pad="2" data-key="D">D</div>
        <div class="pad blue"  data-pad="3" data-key="F">F</div>
      </div>

      <div class="right">
        <div class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div>
              <div class="muted">Mode</div>
              <div class="mode-select" role="tablist" aria-label="Mode selection">
                <button class="mode-btn active small" data-mode="classic">Classic</button>
                <button class="mode-btn small" data-mode="time">Time Attack</button>
                <button class="mode-btn small" data-mode="free">Free Play</button>
              </div>
            </div>
            <div style="text-align:right">
              <div class="muted">Top Score</div>
              <div id="topScore" class="big-score">0</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="startBtn" class="small">Start</button>
            <button id="strictBtn" class="small">Strict: Off</button>
            <button id="soundToggle" class="small">Sound: On</button>
            <label style="margin-left:auto" class="muted small" title="Sequence speed">
              Speed
              <input id="speed" type="range" min="0.6" max="1.6" step="0.1" value="1" style="vertical-align:middle;margin-left:8px">
            </label>
          </div>

          <div class="stats" style="margin-top:12px">
            <div class="stat">Level: <span id="level">0</span></div>
            <div class="stat">Score: <span id="score">0</span></div>
            <div class="stat">Streak: <span id="streak">0</span></div>
            <div class="stat">Mistakes: <span id="mistakes">0</span></div>
          </div>
        </div>

        <div class="panel instructions">
          <strong>How to play</strong>
          <ul>
            <li><b>Classic:</b> Watch the sequence, repeat it. Sequence grows each round.</li>
            <li><b>Time Attack:</b> Score as many correct presses as possible in 30 seconds.</li>
            <li><b>Free Play:</b> Tap pads to play melodies and practice.</li>
          </ul>
          <div style="margin-top:8px" class="muted">Tip: Toggle strict mode to reset on mistake. Speed slider changes sequence playback speed.</div>
        </div>

        <div class="panel">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <div>
              <div class="muted">Controls</div>
              <div style="margin-top:6px">
                <span class="kbd">A</span> <span class="kbd">S</span> <span class="kbd">D</span> <span class="kbd">F</span>
              </div>
            </div>
            <div style="text-align:right">
              <div class="muted">Mode time</div>
              <div id="modeInfo">--</div>
            </div>
          </div>
        </div>

        <div class="footer">
          <div class="muted">Made for fun â€” enjoy making music!</div>
          <div>
            <button id="resetScores" class="small">Reset Scores</button>
          </div>
        </div>

        <div class="note" style="margin-top:10px;font-size:13px;color:#9fb7d4">Mobile: tap pads. Desktop: keys A,S,D,F or click.</div>
      </div>
    </div>
  </div>

<script>
/*
  BeatBox - Single-file musical game
  - 4 pads (green, red, yellow, blue)
  - Modes: classic (simon), time attack, free play
  - Sound via Web Audio (synth)
  - LocalStorage for high scores
  - Keyboard & touch support
*/

(() => {
  // UI elements
  const pads = Array.from(document.querySelectorAll('.pad'));
  const startBtn = document.getElementById('startBtn');
  const strictBtn = document.getElementById('strictBtn');
  const soundToggle = document.getElementById('soundToggle');
  const modeBtns = Array.from(document.querySelectorAll('.mode-btn'));
  const speedSlider = document.getElementById('speed');
  const levelEl = document.getElementById('level');
  const scoreEl = document.getElementById('score');
  const streakEl = document.getElementById('streak');
  const mistakesEl = document.getElementById('mistakes');
  const topScoreEl = document.getElementById('topScore');
  const modeInfo = document.getElementById('modeInfo');
  const resetScores = document.getElementById('resetScores');

  // Game state
  let audioCtx = null;
  let masterGain = null;
  let soundOn = true;
  let currentMode = 'classic'; // 'classic' | 'time' | 'free'
  let strict = false;
  let playingSequence = false;
  let sequence = [];
  let playerIndex = 0;
  let level = 0, score = 0, streak = 0, mistakes = 0;
  let playbackSpeed = 1;
  let timeAttackTimer = null;
  let timeLeft = 30;
  const TIME_ATTACK_DURATION = 30; // seconds

  // tones (frequencies) for pads - musical-ish intervals
  const padFreq = [523.25, 392.00, 659.25, 293.66]; // C5, G4, E5, D4

  // High score key
  const HS_KEY = 'beatbox_highscores_v1';
  function loadHighScores(){
    const raw = localStorage.getItem(HS_KEY);
    return raw ? JSON.parse(raw) : {classic:0,time:0,free:0};
  }
  function saveHighScores(scores){
    localStorage.setItem(HS_KEY, JSON.stringify(scores));
  }
  let highScores = loadHighScores();

  // Initialize UI
  function updateTopScore(){
    topScoreEl.textContent = highScores[currentMode] || 0;
  }
  updateTopScore();

  function applyModeVisuals(){
    modeBtns.forEach(b=>b.classList.toggle('active', b.dataset.mode === currentMode));
    modeInfo.textContent = currentMode === 'classic' ? 'Classic Simon â€” repeat the pattern' :
                        currentMode === 'time' ? `Time Attack â€” ${TIME_ATTACK_DURATION}s` : 'Free Play â€” make music';
    updateTopScore();
  }
  applyModeVisuals();

  // Web Audio helpers
  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.15;
    masterGain.connect(audioCtx.destination);
  }

  function playTone(freq, duration = 0.35, type = 'sine'){
    if(!soundOn) return;
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = 0;
    o.connect(g);
    g.connect(masterGain);
    const now = audioCtx.currentTime;
    // quick envelope
    g.gain.cancelScheduledValues(now);
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(1.0, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + duration);
    o.start(now);
    o.stop(now + duration + 0.02);
  }

  // Visually flash pad and play sound
  function flashPad(i, immediate=false){
    const el = pads[i];
    el.classList.add('flash');
    el.classList.add('pulse');
    const tone = padFreq[i];
    // short voice variety
    const waveform = (i % 2 === 0) ? 'sine' : 'triangle';
    // schedule sound slightly after to sync with CSS
    setTimeout(()=> playTone(tone, 0.35 / playbackSpeed, waveform), immediate ? 0 : 20);
    setTimeout(()=> {
      el.classList.remove('flash');
      el.classList.remove('pulse');
    }, Math.max(220, 320 / playbackSpeed));
  }

  // Sequence generation & playback (classic)
  function addRandomToSequence(){
    const next = Math.floor(Math.random()*pads.length);
    sequence.push(next);
    level = sequence.length;
    levelEl.textContent = level;
  }

  async function playSequence(){
    playingSequence = true;
    playerIndex = 0;
    startBtn.disabled = true;
    // small delay
    await sleep(300);
    const baseDelay = 600 / playbackSpeed;
    for(let i=0;i<sequence.length;i++){
      const idx = sequence[i];
      flashPad(idx);
      await sleep(baseDelay);
    }
    playingSequence = false;
    startBtn.disabled = false;
  }

  // Player input handling
  function handlePadPress(i){
    if(!audioCtx) ensureAudio();
    // modes
    if(currentMode === 'free'){
      // just play
      flashPad(i, true);
      score += 1;
      streak += 1;
      updateStats();
      maybeUpdateHighScore();
      return;
    }

    if(currentMode === 'time' && timeAttackTimer === null){
      // starting time attack
      startTimeAttack();
    }

    if(playingSequence) return; // ignore presses while sequence plays

    flashPad(i, true);

    if(currentMode === 'classic'){
      const expected = sequence[playerIndex];
      if(i === expected){
        playerIndex++;
        score += 10 + level; // reward
        streak++;
        updateStats();
        if(playerIndex >= sequence.length){
          // success, next round
          setTimeout(()=> {
            addRandomToSequence();
            updateStats();
            playSequence();
          }, 500);
        }
      } else {
        // mistake
        mistakes++;
        streak = 0;
        updateStats();
        if(strict){
          // reset everything
          loseAndReset("Wrong! Strict mode resets the game.");
        } else {
          // replay same sequence
          startBtn.disabled = true;
          // show a 'wrong' wiggle
          document.querySelector('.wrap').classList.add('shake');
          setTimeout(()=> document.querySelector('.wrap').classList.remove('shake'), 300);
          setTimeout(()=> {
            playSequence();
          }, 800);
        }
      }
      maybeUpdateHighScore();
    } else if(currentMode === 'time'){
      // in time attack, each correct press (no sequence) yields score
      // We treat any pad press as positive â€” add to score and streak
      score += 5;
      streak++;
      updateStats();
      maybeUpdateHighScore();
    }
  }

  function updateStats(){
    levelEl.textContent = level;
    scoreEl.textContent = score;
    streakEl.textContent = streak;
    mistakesEl.textContent = mistakes;
  }

  function maybeUpdateHighScore(){
    if(score > (highScores[currentMode] || 0)){
      highScores[currentMode] = score;
      saveHighScores(highScores);
      updateTopScore();
    }
  }

  function loseAndReset(message){
    // show message briefly
    alert(message || 'Wrong!');
    resetGameState();
  }

  // helpers
  function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

  // Controls
  startBtn.addEventListener('click', ()=> {
    if(currentMode === 'classic') startClassic();
    else if(currentMode === 'time') startTimeAttack();
    else {
      // free mode just resets counter and enters free-play
      resetGameState();
      modeInfo.textContent = 'Free Play â€” make music';
      updateStats();
    }
  });

  strictBtn.addEventListener('click', ()=> {
    strict = !strict;
    strictBtn.textContent = `Strict: ${strict ? 'On' : 'Off'}`;
  });

  soundToggle.addEventListener('click', ()=> {
    soundOn = !soundOn;
    soundToggle.textContent = `Sound: ${soundOn ? 'On' : 'Off'}`;
    if(!soundOn && audioCtx) audioCtx.suspend && audioCtx.suspend();
    else if(soundOn && audioCtx) audioCtx.resume && audioCtx.resume();
  });

  modeBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      currentMode = b.dataset.mode;
      resetGameState();
      applyModeVisuals();
    });
  });

  resetScores.addEventListener('click', ()=>{
    if(confirm('Reset all high scores?')){
      highScores = {classic:0,time:0,free:0};
      saveHighScores(highScores);
      updateTopScore();
      alert('High scores reset.');
    }
  });

  speedSlider.addEventListener('input', (e)=>{
    playbackSpeed = parseFloat(e.target.value);
  });

  // Keyboard bindings
  const keyMap = {'a':0,'s':1,'d':2,'f':3};
  window.addEventListener('keydown', (ev)=>{
    if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
    const k = ev.key.toLowerCase();
    if(k in keyMap){
      const idx = keyMap[k];
      animatePadPress(idx);
      handlePadPress(idx);
    } else if(k === ' '){
      // space to start
      ev.preventDefault();
      startBtn.click();
    }
  });

  // Pad click/touch
  pads.forEach((p, i)=>{
    p.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      animatePadPress(i);
      handlePadPress(i);
    });
  });

  function animatePadPress(i){
    const el = pads[i];
    el.classList.add('flash');
    setTimeout(()=> el.classList.remove('flash'), 180);
  }

  // Classic mode flow
  function startClassic(){
    resetGameState();
    sequence = [];
    addRandomToSequence();
    updateStats();
    playSequence();
  }

  // Time attack mode
  function startTimeAttack(){
    resetGameState();
    currentMode = 'time';
    applyModeVisuals();
    timeLeft = TIME_ATTACK_DURATION;
    modeInfo.textContent = `${timeLeft}s left`;
    // start timer
    if(timeAttackTimer) clearInterval(timeAttackTimer);
    timeAttackTimer = setInterval(()=>{
      timeLeft--;
      modeInfo.textContent = `${timeLeft}s left`;
      if(timeLeft <= 0){
        clearInterval(timeAttackTimer);
        timeAttackTimer = null;
        finishTimeAttack();
      }
    },1000);
  }

  function finishTimeAttack(){
    alert(`Time's up! Score: ${score}`);
    maybeUpdateHighScore();
    resetGameState();
  }

  // Reset state but keep mode selection
  function resetGameState(){
    playingSequence = false;
    sequence = [];
    playerIndex = 0;
    level = 0;
    score = 0;
    streak = 0;
    mistakes = 0;
    levelEl.textContent = 0;
    scoreEl.textContent = 0;
    streakEl.textContent = 0;
    mistakesEl.textContent = 0;
    startBtn.disabled = false;
    if(timeAttackTimer){ clearInterval(timeAttackTimer); timeAttackTimer = null; }
    modeInfo.textContent = currentMode === 'classic' ? 'Classic Simon â€” repeat the pattern' :
                        currentMode === 'time' ? `Time Attack â€” ${TIME_ATTACK_DURATION}s` : 'Free Play â€” make music';
  }

  // update top score when mode changes
  window.addEventListener('focus', updateTopScore);

  // small animation: shake class (for error)
  const style = document.createElement('style');
  style.textContent = `
    .shake { animation: shakeit 380ms cubic-bezier(.5,.1,.5,1); }
    @keyframes shakeit { 0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }
  `;
  document.head.appendChild(style);

  // On load: resume audio on first interaction (some browsers require user gesture)
  function resumeAudioOnUserAction(){
    if(!audioCtx) ensureAudio();
    if(audioCtx.state === 'suspended') {
      audioCtx.resume().catch(()=>{/*ignored*/});
    }
    window.removeEventListener('pointerdown', resumeAudioOnUserAction);
    window.removeEventListener('keydown', resumeAudioOnUserAction);
  }
  window.addEventListener('pointerdown', resumeAudioOnUserAction);
  window.addEventListener('keydown', resumeAudioOnUserAction);

  // Initialize visual labels
  function setPadKeyLabels(){
    pads.forEach(p => {
      // data-key already set (A S D F)
      const key = p.dataset.key || '';
      if(key) p.textContent = key;
    });
  }
  setPadKeyLabels();

  // Initial stats update
  updateStats();

  // pre-warm audio (small click) so first tone is not delayed
  (function warmupAudio(){
    try {
      ensureAudio();
      playTone(220, 0.02);
    } catch(e){}
  })();

  // Expose small debug (not required)
  window._beatbox = {
    reset: resetGameState, playSeq: playSequence
  };
})();
</script>
</body>
</html>