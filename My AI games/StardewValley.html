<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Playable 3D Farm</title>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background-color: #f0f8e9;
			}
			canvas {
				display: block;
			}
			#info {
				position: absolute;
				top: 10px;
				left: 10px;
				color: white;
				font-family: Arial, sans-serif;
				font-size: 1.2em;
				text-shadow: 1px 1px 2px black;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
			}
			#money-counter {
				position: absolute;
				top: 10px;
				right: 10px;
				color: white;
				font-family: Arial, sans-serif;
				font-size: 1.2em;
				text-shadow: 1px 1px 2px black;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
			}
			#message {
				position: absolute;
				bottom: 10px;
				left: 50%;
				transform: translateX(-50%);
				color: white;
				font-family: Arial, sans-serif;
				font-size: 1.2em;
				text-shadow: 1px 1px 2px black;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 10px;
				border-radius: 5px;
				transition: opacity 1s;
			}
		</style>
	</head>
	<body>
		<div id="info">
			Use WASD and mouse to move. Click plots to plant and harvest.
		</div>
		<div id="money-counter">Money: $<span id="money">0</span></div>
		<div id="message"></div>

		<!-- Three.js Library included directly -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

		<script>
			// --- SCENE SETUP ---
			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera(
				75,
				window.innerWidth / window.innerHeight,
				0.1,
				1000
			);
			const renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);
			camera.position.set(0, 1.6, 15);

			// Lighting
			const ambientLight = new THREE.AmbientLight(0x404040, 2);
			scene.add(ambientLight);
			const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
			directionalLight.position.set(5, 5, 5);
			scene.add(directionalLight);

			// Ground and sky
			const groundGeometry = new THREE.PlaneGeometry(50, 50);
			const groundMaterial = new THREE.MeshLambertMaterial({
				color: 0x669933,
			});
			const ground = new THREE.Mesh(groundGeometry, groundMaterial);
			ground.rotation.x = -Math.PI / 2;
			scene.add(ground);
			const skyGeometry = new THREE.SphereGeometry(250, 32, 32);
			const skyMaterial = new THREE.MeshBasicMaterial({
				color: 0x87ceeb,
				side: THREE.BackSide,
			});
			const sky = new THREE.Mesh(skyGeometry, skyMaterial);
			scene.add(sky);

			// --- GAME LOGIC & STATE ---
			let money = 0;
			const plots = [];
			const moneyElement = document.getElementById("money");
			const messageElement = document.getElementById("message");

			const FIELD_STATES = {
				EMPTY: { color: 0x964b00, growTime: 0, model: "plot" },
				PLANTED: {
					color: 0x00ff00,
					growTime: 5,
					model: "plant_stage1",
				},
				GROWING: {
					color: 0x00aa00,
					growTime: 2,
					model: "plant_stage2",
				},
				MATURE: { color: 0xffff00, growTime: 0, model: "plant_stage3" },
			};

			// Create the farm plots
			function createPlot(x, z) {
				const plotGeometry = new THREE.BoxGeometry(2, 0.1, 2);
				const plotMaterial = new THREE.MeshLambertMaterial({
					color: FIELD_STATES.EMPTY.color,
				});
				const plotMesh = new THREE.Mesh(plotGeometry, plotMaterial);
				plotMesh.position.set(x, 0.05, z);
				plotMesh.userData = {
					state: "empty",
					growTime: 0,
					plantMesh: null,
				};
				plots.push(plotMesh);
				scene.add(plotMesh);
				return plotMesh;
			}

			// Populate the farm with plots
			for (let x = -4; x <= 4; x += 4) {
				for (let z = -4; z <= 4; z += 4) {
					createPlot(x, z);
				}
			}

			function updatePlantModel(plot) {
				if (plot.userData.plantMesh) {
					scene.remove(plot.userData.plantMesh);
				}

				let newPlantMesh = null;
				if (plot.userData.state === "planted") {
					const plantGeometry = new THREE.ConeGeometry(0.2, 1, 8);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.PLANTED.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				} else if (plot.userData.state === "growing") {
					const plantGeometry = new THREE.CylinderGeometry(
						0.4,
						0.4,
						1.2,
						12
					);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.GROWING.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				} else if (plot.userData.state === "mature") {
					const plantGeometry = new THREE.SphereGeometry(0.5, 12, 12);
					const plantMaterial = new THREE.MeshLambertMaterial({
						color: FIELD_STATES.MATURE.color,
					});
					newPlantMesh = new THREE.Mesh(plantGeometry, plantMaterial);
				}

				if (newPlantMesh) {
					newPlantMesh.position.set(
						plot.position.x,
						0.6,
						plot.position.z
					);
					scene.add(newPlantMesh);
					plot.userData.plantMesh = newPlantMesh;
				}
			}

			function showMessage(text) {
				messageElement.textContent = text;
				messageElement.style.opacity = 1;
				setTimeout(() => {
					messageElement.style.opacity = 0;
				}, 3000);
			}

			// Game loop for plant growth
			setInterval(() => {
				plots.forEach((plot) => {
					if (
						plot.userData.state === "planted" ||
						plot.userData.state === "growing"
					) {
						if (plot.userData.growTime > 0) {
							plot.userData.growTime--;
							if (plot.userData.growTime === 2) {
								plot.userData.state = "growing";
								updatePlantModel(plot);
							} else if (plot.userData.growTime === 0) {
								plot.userData.state = "mature";
								updatePlantModel(plot);
								showMessage("A crop is ready to harvest!");
							}
						}
					}
				});
			}, 2000);

			// --- PLAYER CONTROLS & INTERACTION ---
			const raycaster = new THREE.Raycaster();
			const mouse = new THREE.Vector2();

			// Player movement controls
			const controls = {
				forward: false,
				backward: false,
				left: false,
				right: false,
			};
			const playerSpeed = 0.07;
			document.addEventListener("keydown", (e) => {
				if (e.key === "w") controls.forward = true;
				if (e.key === "s") controls.backward = true;
				if (e.key === "a") controls.left = true;
				if (e.key === "d") controls.right = true;
			});
			document.addEventListener("keyup", (e) => {
				if (e.key === "w") controls.forward = false;
				if (e.key === "s") controls.backward = false;
				if (e.key === "a") controls.left = false;
				if (e.key === "d") controls.right = false;
			});
			let isMouseDown = false;
			document.addEventListener("mousedown", () => (isMouseDown = true));
			document.addEventListener("mouseup", () => (isMouseDown = false));
			document.addEventListener("mousemove", (e) => {
				if (isMouseDown) {
					const sensitivity = 0.002;
					camera.rotation.y -= e.movementX * sensitivity;
					camera.rotation.x -= e.movementY * sensitivity;
					camera.rotation.x = Math.max(
						-Math.PI / 2,
						Math.min(Math.PI / 2, camera.rotation.x)
					);
				}
			});

			// Click interaction
			window.addEventListener(
				"click",
				(event) => {
					mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
					mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
					raycaster.setFromCamera(mouse, camera);

					const intersects = raycaster.intersectObjects(plots);
					if (intersects.length > 0) {
						const clickedPlot = intersects[0].object;
						const state = clickedPlot.userData.state;

						switch (state) {
							case "empty":
								clickedPlot.userData.state = "planted";
								clickedPlot.userData.growTime =
									FIELD_STATES.PLANTED.growTime;
								updatePlantModel(clickedPlot);
								showMessage("You planted a new crop!");
								break;
							case "planted":
							case "growing":
								if (clickedPlot.userData.growTime > 0) {
									clickedPlot.userData.growTime--;
									showMessage("You watered the crop!");
								}
								break;
							case "mature":
								money += 10;
								moneyElement.textContent = money;
								clickedPlot.userData.state = "empty";
								clickedPlot.userData.growTime = 0;
								scene.remove(clickedPlot.userData.plantMesh);
								clickedPlot.userData.plantMesh = null;
								showMessage(
									"You harvested a crop and earned $10!"
								);
								break;
						}
					}
				},
				false
			);

			// --- ANIMATION LOOP ---
			function animate() {
				requestAnimationFrame(animate);

				// Movement logic
				const direction = new THREE.Vector3();
				camera.getWorldDirection(direction);
				const right = new THREE.Vector3();
				right.crossVectors(direction, camera.up);

				if (controls.forward)
					camera.position.add(direction.multiplyScalar(playerSpeed));
				if (controls.backward)
					camera.position.add(direction.multiplyScalar(-playerSpeed));
				if (controls.left)
					camera.position.add(right.multiplyScalar(-playerSpeed));
				if (controls.right)
					camera.position.add(right.multiplyScalar(playerSpeed));

				renderer.render(scene, camera);
			}
			animate();
		</script>
	</body>
</html>
